<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/miembros.css') }}">
  <script src="https://kit.fontawesome.com/eb496ab1a0.js" crossorigin="anonymous"></script>
  <link rel="icon" href="{{ url_for('static', filename='media/Logo-verde.ico') }}">
  <link rel="stylesheet" href="https://bootswatch.com/4/materia/bootstrap.min.css">
  <title>Control de plantas</title>
  <style>
    body {
      background-color: #111222;
    }

    h2 {
      color: white;
    }
  </style>
</head>

<body>
  {% extends 'base-log.html'%}

  {% block body %}

  <div class="col-md-12">
    <h2>Control de plantas</h2>

    <!-- Sección de Exportación -->
    <div class="card mb-4" style="background: rgba(40, 167, 69, 0.1); border: 1px solid #28a745;">
      <div class="card-body">
        <h5 class="card-title" style="color: #28a745;"><i class="fas fa-file-excel"></i> Exportar a Excel</h5>
        <div class="form-inline">
          <div class="form-group mr-3 mb-2">
            <label for="fecha_inicio" class="mr-2" style="color: white;">Desde:</label>
            <input type="date" class="form-control" id="fecha_inicio">
          </div>
          <div class="form-group mr-3 mb-2">
            <label for="fecha_fin" class="mr-2" style="color: white;">Hasta:</label>
            <input type="date" class="form-control" id="fecha_fin">
          </div>
          <a href="#" id="btn-exportar" class="btn btn-success mb-2" onclick="descargarExcel(event)">
            <i class="fas fa-download"></i> Descargar Excel
          </a>
          <small class="form-text text-muted ml-3" style="color: #888 !important;">
            Deja vacío para exportar todos los registros
          </small>
        </div>
      </div>
    </div>

    <script>
      function descargarExcel(e) {
        e.preventDefault();
        var fechaInicio = document.getElementById('fecha_inicio').value;
        var fechaFin = document.getElementById('fecha_fin').value;
        var url = "{{ url_for('exportar_plantas') }}";
        var params = [];
        if (fechaInicio) params.push('fecha_inicio=' + fechaInicio);
        if (fechaFin) params.push('fecha_fin=' + fechaFin);
        if (params.length > 0) url += '?' + params.join('&');

        // Mostrar indicador de carga
        var btn = document.getElementById('btn-exportar');
        var originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
        btn.style.pointerEvents = 'none';

        // Usar fetch para obtener el archivo y forzar nombre correcto
        fetch(url, {
          method: 'GET',
          credentials: 'same-origin'
        })
          .then(response => {
            // Extraer nombre del header si existe
            var filename = 'control_plantas.xlsx';
            var disposition = response.headers.get('Content-Disposition');
            if (disposition && disposition.indexOf('filename=') !== -1) {
              var match = disposition.match(/filename="([^"]+)"/);
              if (match) filename = match[1];
            }
            return response.blob().then(blob => ({ blob, filename }));
          })
          .then(({ blob, filename }) => {
            // Crear link temporal y forzar descarga
            var link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(link.href);

            // Restaurar botón
            btn.innerHTML = originalText;
            btn.style.pointerEvents = 'auto';
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error al descargar. Intenta de nuevo.');
            btn.innerHTML = originalText;
            btn.style.pointerEvents = 'auto';
          });
      }
    </script>

    <table id="miembros" class="table table-stripped table-bordered bg-white table-sm">
      <thead>
        <tr>
          <th>Planta id</th>
          <th>Raza</th>
          <th>Riego</th>
          <th>Enraizado</th>
          <th>1er trasplante</th>
          <th>2do trasplante</th>
          <th>3er trasplante</th>
          <th>Floracion</th>
          <th>Cosecha</th>
          <th>Cantidad</th>
          <th>Observaciones</th>
          <th style="height: 40px;">Operaciones</th>
        </tr>
      </thead>
      <tbody>
        {% for planta in planta %}
        <tr>
          <td>{{ planta.idplanta }}</td>
          <td>{{ planta.raza }}</td>
          <td>{{ planta.Riego }}</td>
          <td>{{ planta.Enraizado }}</td>
          <td>{{ planta.paso1 }}</td>
          <td>{{ planta.paso2 }}</td>
          <td>{{ planta.paso3 }}</td>
          <td>{{ planta.floracion }}</td>
          <td>{{ planta.cosecha }}</td>
          <td>{{ planta.cantidad }}</td>
          <td>{{ planta.observaciones }}</td>

          <td>
            <a href="/editplanta/{{planta.idplanta}}" class="btn btn-secondary btn-sm">Editar</a>
            <form action="/deleteplanta/{{planta.idplanta}}" method="POST" style="display: inline;"
              onsubmit="return confirm('¿Estás seguro de eliminar esta planta?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-danger btn-sm">Borrar</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  </div>
  {% endblock %}
</body>
<script>
  let btnEdit = document.getElementById('btndit');
  btnEdit.addEventListener('click', function () {
    alert('Seguro que desea editar el miembro?');
  });

  let btnDelete = document.getElementById('btndlete');
  btnDelete.addEventListener('click', function (event) {
    var confirmation = confirm('¿Estás seguro de que deseas eliminar el miembro?');
    if (!confirmation) {
      event.preventDefault();
      console.log('La eliminación del miembro fue cancelada.');
    }
  });
</script>

</html>