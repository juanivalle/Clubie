{% extends 'base-log.html'%}

{% block body %}
<link rel="stylesheet" href="https://bootswatch.com/4/materia/bootstrap.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/miembros.css') }}">
<title>Ventas</title>

<div class="row">
  <div class="col-md-7">
    <h2>Ventas</h2>

    <!-- Mensajes de alerta -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-3">
      {% for category, message in messages %}
      <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show"
        role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
    <table class="table table-striped table-bordered bg-white table-sm">
      <thead>
        <tr>
          <th>ID Venta</th>
          <th>Cédula</th>
          <th>Raza</th>
          <th>Cantidad</th>
          <th>Retiro</th>
          <th>Operación</th>
        </tr>
      </thead>
      <tbody>
        {% for venta in ventas %}
        <tr>
          <td>{{ venta.idventas }}</td>
          <td>{{ venta.cedula }}</td>
          <td>{{ venta.raza }}</td>
          <td>{{ venta.cantidad }}</td>
          <td>{{ venta.retiro.strftime('%Y-%m-%dT%H:%M') }}</td>
          <td>
            <form action="/delete-venta/{{venta.idventas}}" method="POST" style="display: inline;"
              onsubmit="return confirm('¿Estás seguro de eliminar esta venta?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="col-md-5">
    <div class="card card-body">
      <h2>Nueva Venta</h2>
      <form action="/registerventas" method="POST" autocomplete="off">
        {{ form.csrf_token }}
        <div class="form-group">
          <label>Cédula</label>
          <input id="txtCi" type="text" name="cedulaVenta" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Nombre de Usuario</label>
          <p id="username-display" class="form-control-plaintext text-muted">Ingrese una cédula...</p>
        </div>
        <div class="form-group">
          <label for="razaVenta">Raza:</label>
          <input type="text" name="razaVenta" id="razaVenta" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="cantidad">Cantidad (gramos):</label>
          <input type="number" name="cantVenta" id="cantidad" class="form-control" min="1" max="40" required>
        </div>
        <div class="form-group">
          <label>Fecha de Retiro</label>
          <input id="fechaVenta" type="datetime-local" name="retiro" class="form-control" required>
        </div>
        <div class="form-group">
          <input type="submit" value="Guardar Venta" class="btn btn-primary btn-block" id="btnsave">
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Buscar nombre de usuario al ingresar cédula
  let cedulaField = document.querySelector('#txtCi');
  let usernameDisplay = document.querySelector('#username-display');

  cedulaField.addEventListener('input', function () {
    let cedula = cedulaField.value;
    if (cedula.length >= 7) {
      fetch('/get-username?cedula=' + cedula)
        .then(response => response.text())
        .then(username => {
          usernameDisplay.textContent = username;
          if (username === 'Usuario no encontrado') {
            usernameDisplay.classList.add('text-danger');
            usernameDisplay.classList.remove('text-success');
          } else {
            usernameDisplay.classList.add('text-success');
            usernameDisplay.classList.remove('text-danger');
          }
        });
    } else {
      usernameDisplay.textContent = 'Ingrese una cédula...';
      usernameDisplay.classList.remove('text-success', 'text-danger');
    }
  });
</script>
{% endblock %}